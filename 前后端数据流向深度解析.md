# 中国宏观经济大数据AI预测系统 - 前后端数据流向深度解析

## 系统架构概览

这是一个基于 **Vue.js + FastAPI** 的全栈经济数据分析预测系统，集成了AI对话、数据可视化、语音交互等功能。

## 1. 数据源层 (Data Sources)

### 1.1 原始数据来源
- **国家统计局数据**: 历史经济指标数据
- **社科数值混频模型**: DATACY、DATADM、DATADWL、DATALF等数据集
- **预测模型输出**: 基于机器学习的月度/季度预测结果
- **百度千帆AI平台**: 提供对话分析和智能问答服务
- **百度语音服务**: ASR语音识别和TTS语音合成

### 1.2 数据特点
- **时间跨度**: 2001年至2025年的经济数据
- **数据频率**: 月度、季度数据
- **指标类型**: GDP、CPI、PPI、社会消费品零售总额、固定资产投资等
- **预测标识**: 2025年6月后的数据标记为预测数据

## 2. 后端数据处理层 (Backend Data Layer)

### 2.1 数据文件存储结构

#### 核心数据文件
```
backend/data/
├── DATAMERGED-20241203-完整数据集-修复版.csv  # 历史经济数据主文件
├── gdp_complete_data.csv                      # GDP季度数据+预测
└── cache/                                     # 数据缓存目录

update/
├── 月度关键数据预测结果含区间.csv              # 月度预测+置信区间
├── 月度数据完整合并结果.csv                   # 历史+预测合并数据
└── 季度关键数据预测结果含区间.csv              # 季度预测数据
```

#### 数据文件详细说明

**DATAMERGED-20241203-完整数据集-修复版.csv**
- 包含2001-2024年历史经济数据
- 字段: date, GDP不变价:当季同比, 中国:社会消费品零售总额:当月同比, 中国:CPI:当月同比等
- 数据清洗: 去除逗号分隔符，处理无效值和无限值

**月度关键数据预测结果含区间.csv**
- 包含2025年6-12月预测数据
- 特色: 每个指标都有对应的_variation字段表示置信区间
- 格式: timestamp, 指标名称, 指标名称_variation

### 2.2 数据库存储 (SQLite)

```sql
-- 对话表
CREATE TABLE conversations (
    id INTEGER PRIMARY KEY,
    conversation_id STRING UNIQUE,
    created_at DATETIME
);

-- 消息表  
CREATE TABLE messages (
    id INTEGER PRIMARY KEY,
    conversation_id STRING,
    role STRING,           -- 'user' 或 'assistant'
    content TEXT,
    created_at DATETIME
);
```

### 2.3 数据处理模块

#### process_all_data() 函数
```python
# 启动时数据预处理
async def process_all_data():
    # 1. 读取CSV文件，处理编码问题
    # 2. 重命名列，设置日期索引
    # 3. 数据清洗：去除逗号，转换数值类型
    # 4. 处理无效值：inf, -inf, NaN
    # 5. 存储到全局变量 processed_data
```

#### get_cached_page_data() 缓存机制
```python
@lru_cache(maxsize=1000)
def get_cached_page_data(page, page_size, search):
    # 1. 分页处理大量指标数据
    # 2. 搜索过滤功能
    # 3. 数据格式标准化
    # 4. LRU缓存提升性能
```

## 3. 后端API服务层 (Backend API Layer)

### 3.1 FastAPI应用架构

**主要API端点:**

#### 数据查询API
- `GET /api/key-indicators` - 首页关键指标数据
- `GET /api/gdp-data` - GDP季度数据
- `GET /api/key-indicators-series` - 关键指标时间序列
- `GET /api/chart-data` - 图表数据分页查询
- `GET /api/monthly-prediction-data` - 月度预测数据

#### AI对话API
- `POST /conversation` - 创建新对话
- `POST /stream` - 流式聊天响应
- `POST /chat` - 普通聊天响应

#### 语音交互API
- `POST /asr` - 语音识别
- `POST /tts` - 语音合成

#### 分析API
- `POST /api/macro-analysis` - 宏观经济分析
- `POST /api/gdp-analysis` - GDP数据分析

### 3.2 外部API集成

#### 百度千帆AI平台
```python
BASE_URL = "https://qianfan.baidubce.com/v2/app"
AUTH_STRING = "bce-v3/ALTAK-YLij17TdPMsg11izg9HAn/..."

# 对话流程
1. POST /conversation -> 获取conversation_id
2. POST /conversation/runs -> 发送查询，获取AI响应
3. 支持流式和非流式响应
```

#### 百度语音服务
```python
# ASR语音识别
POST https://vop.baidu.com/server_api
# TTS语音合成  
GET http://tsn.baidu.com/text2audio
```

### 3.3 数据处理逻辑

#### 关键指标数据处理
```python
async def get_key_indicators():
    # 1. 获取当前时间，计算最新可用数据时间点
    # 2. 读取GDP数据文件，查找对应季度
    # 3. 读取月度数据文件，查找对应月份
    # 4. 判断是否为预测数据（2025年6月后）
    # 5. 处理置信区间数据
    # 6. 返回标准化格式
```

## 4. 前端应用层 (Frontend Layer)

### 4.1 Vue.js应用配置

#### API配置
```javascript
// src/config.js
export const API_BASE_URL = 'http://120.48.150.254:8888'

// src/config/axios.js  
axios.defaults.baseURL = 'http://120.48.150.254:8888'
```

### 4.2 页面组件数据流

#### Home.vue - 首页经济指标展示
```javascript
const loadData = async () => {
    // 1. 获取关键经济指标数据
    const keyIndicatorsResponse = await axios.get(`${API_BASE_URL}/api/key-indicators`)
    
    // 2. 获取GDP季度数据  
    const gdpResponse = await axios.get(`${API_BASE_URL}/api/gdp-data`)
    
    // 3. 获取关键指标时间序列数据
    const seriesResponse = await axios.get(`${API_BASE_URL}/api/key-indicators-series`)
    
    // 4. 更新响应式数据
    economicIndicators.value = processKeyIndicators(keyData)
    
    // 5. 渲染ECharts图表
    renderChart(seriesData)
}
```

#### Database.vue - 数据库查询界面
```javascript
const fetchData = async () => {
    // 分页查询月度预测数据
    const response = await axios.get(`${API_BASE_URL}/api/monthly-prediction-data`, {
        params: {
            page: currentPage.value,
            page_size: pageSize.value, 
            search: searchQuery.value
        }
    })
    
    // 处理响应数据，更新图表
    chartData.value = response.data.data
}
```

#### AIAssistant.vue - AI助手聊天
```javascript
const sendMessage = async () => {
    // 1. 创建对话（如果需要）
    if (!currentConversationId.value) {
        await createNewConversation()
    }
    
    // 2. 发送流式请求
    const response = await fetch(`${API_BASE_URL}/stream`, {
        method: 'POST',
        body: JSON.stringify({
            conversation_id: currentConversationId.value,
            query: userMessage
        })
    })
    
    // 3. 处理流式响应
    const reader = response.body.getReader()
    while (true) {
        const { done, value } = await reader.read()
        if (done) break
        
        // 解析并显示流式数据
        const chunk = new TextDecoder().decode(value)
        // 更新消息内容
    }
    
    // 4. 保存到localStorage
    localStorage.setItem(`messages_${conversationId}`, JSON.stringify(messages.value))
}
```

### 4.3 数据可视化

#### ECharts图表集成
```javascript
import * as echarts from 'echarts'

const renderChart = (data) => {
    const chart = echarts.init(chartRef.value)
    
    const option = {
        xAxis: { data: data.dates },
        yAxis: {},
        series: [{
            data: data.values,
            type: 'line',
            markLine: {
                data: [{ xAxis: '2025-06' }] // 预测数据分界线
            }
        }]
    }
    
    chart.setOption(option)
}
```

### 4.4 本地存储机制

#### localStorage数据结构
```javascript
// 对话历史
localStorage.setItem('conversations', JSON.stringify([
    {
        conversation_id: 'uuid',
        title: '对话标题', 
        created_at: '2024-12-03T10:00:00Z'
    }
]))

// 消息记录
localStorage.setItem('messages_uuid', JSON.stringify([
    { role: 'user', content: '用户消息' },
    { role: 'assistant', content: 'AI回复' }
]))
```

## 5. 数据流向总结

### 5.1 完整数据流路径

1. **数据源** → **CSV文件** → **后端预处理** → **API接口** → **前端组件** → **用户界面**

2. **具体流程示例 - 首页数据加载:**
   ```
   国家统计局数据 → DATAMERGED-20241203-完整数据集-修复版.csv 
   → process_all_data()处理 → /api/key-indicators接口 
   → Home.vue组件 → ECharts图表 → 用户看到的指标卡片
   ```

3. **AI对话流程:**
   ```
   用户输入 → AIAssistant.vue → /stream接口 → 百度千帆API 
   → 流式响应 → 前端实时显示 → localStorage存储
   ```

### 5.2 关键技术特点

- **数据缓存**: LRU缓存机制提升查询性能
- **流式响应**: 实时AI对话体验
- **分页处理**: 大数据量的高效展示
- **预测标识**: 清晰区分历史数据和预测数据
- **置信区间**: 预测数据的不确定性量化
- **本地存储**: 对话历史的持久化保存

这个系统通过精心设计的数据流架构，实现了从原始经济数据到智能分析预测的完整链路，为用户提供了专业、高效的宏观经济分析服务。
